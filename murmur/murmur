#!/bin/bash
# @(#) Script to maintain gentoo-based docker image for murmur.

ROOT="${ROOT:-$(dirname $0)}"
source "${ROOT}"/../lib/common.sh

DATADIR="${DATADIR:-/var/data/murmur}"
IMAGE="${IMAGE:-kiyoya/murmur}"
NAME="${NAME:-murmur}"
TAG="${TAG:-latest}"

PACKAGES="media-sound/murmur"

case "${1}" in
build)
  BUILD_TAG="${2:-$(date +%Y%m%d)}"

  bootstrap_create "${NAME}"
  docker cp "${ROOT}"/package.use "${NAME}":/etc/portage/package.use/murmur
  bootstrap_emerge "${NAME}" ${PACKAGES}
  bootstrap_build "${NAME}" "${IMAGE}:${BUILD_TAG}" \
    -c "ENTRYPOINT /usr/bin/murmurd" \
    -c "CMD -fg -ini /etc/murmur/murmur.ini" \
    -c "ENV HOME /var/lib/murmur" \
    -c "EXPOSE 64738" \
    -c "EXPOSE 64738/udp"
  bootstrap_clean "${NAME}"
  ;;
down)
  docker stop "${NAME}"
  docker rm "${NAME}"
  ;;
pull)
  docker pull "${IMAGE}:${TAG}"
  ;;
reload)
  $0 down
  $0 up
  ;;
up)
  docker run -d \
    -p 64738:64738 \
    -p 64738:64738/udp \
    --name "${NAME}" \
    -v "${DATADIR}"/murmur.ini:/etc/murmur/murmur.ini:ro \
    -v "${DATADIR}"/murmur.sqlite:/var/lib/murmur/murmur.sqlite \
    --restart always \
    "${IMAGE}:${TAG}"
  ;;
*)
  echo "usage: $0 [ build | down | pull | reload | up ]"
esac
