#!/bin/bash
# @(#) Script to maintain gentoo-based docker image for machine learning.

ROOT="${ROOT:-$(dirname $0)}"
source "${ROOT}"/../bootstrap.sh

NAME="${NAME:-ml}"
REPO="${REPO:-kiyoya/ml}"
TAG="${TAG:-latest}"
BUILD_TAG="${BUILD_TAG:-$(date +%Y%m%d)}"

PACKAGES="
  =dev-lang/python-2*
  =dev-lang/python-3*
  dev-python/matplotlib
  dev-python/nltk
  dev-python/numpy
  dev-python/pip
  sci-libs/atlas
  sci-libs/scikits_image
  sci-libs/scikits_learn
  sci-libs/scikits_optimization
  sci-libs/scikits_timeseries
  sci-libs/scipy"


case "${1}" in
build)
  bootstrap_create "${NAME}"
  bootstrap_shell "${NAME}" \
    -c 'echo "USE=\"${USE} lapack\"" >> /etc/portage/make.conf'
  bootstrap_package_keywords "${NAME}" "${ROOT}"/package.keywords
  bootstrap_package_use "${NAME}" "${ROOT}"/package.use
  bootstrap_emerge "${NAME}" --update --deep --newuse ${PACKAGES}
  bootstrap_shell_chroot "${NAME}" <<EOM
    set -eu
    pip install chainer
EOM
  bootstrap_build "${NAME}" "${REPO}":"${BUILD_TAG}"
  ;;
promote)
  docker_promote "${REPO}":"${BUILD_TAG}"
  ;;
pull)
  docker pull "${REPO}":"${TAG}"
  ;;
run)
  docker run -it --rm \
    -h "${NAME}" \
    --log-driver=none \
    --user "$(id -u)":"$(id -g)" \
    -v "$(volpath $(pwd))":/root \
    -w /root \
    "${REPO}":"${TAG}" /bin/bash
  ;;
*)
  echo "usage: $0 [ build | promote | pull | run ]"
esac
